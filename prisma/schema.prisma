// QUAD Framework Prisma Schema
// Shared database with NutriNine - all tables prefixed with QUAD_

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // URL is now in prisma.config.ts (Prisma 7+)
}

// ============================================================================
// CORE TABLES
// ============================================================================

model QUAD_companies {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  admin_email String   @unique @db.VarChar(255)
  size        String?  @default("medium") @db.VarChar(50)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  users   QUAD_users[]
  domains QUAD_domains[]
  roles   QUAD_roles[]

  @@map("QUAD_companies")
}

model QUAD_roles {
  id                   String   @id @default(uuid()) @db.Uuid
  company_id           String   @db.Uuid
  role_code            String   @db.VarChar(50)
  role_name            String   @db.VarChar(100)
  description          String?

  // Permission flags
  can_manage_company   Boolean  @default(false)
  can_manage_users     Boolean  @default(false)
  can_manage_domains   Boolean  @default(false)
  can_manage_flows     Boolean  @default(false)
  can_view_all_metrics Boolean  @default(false)
  can_manage_circles   Boolean  @default(false)
  can_manage_resources Boolean  @default(false)

  // Q-U-A-D Stage Participation
  // Values: 'PRIMARY', 'SUPPORT', 'REVIEW', 'INFORM', NULL
  q_participation      String?  @db.VarChar(10)
  u_participation      String?  @db.VarChar(10)
  a_participation      String?  @db.VarChar(10)
  d_participation      String?  @db.VarChar(10)

  // UI display
  color_code           String?  @db.VarChar(20)
  icon_name            String?  @db.VarChar(50)
  display_order        Int      @default(0)

  // Hierarchy (higher = more authority)
  hierarchy_level      Int      @default(0)

  // Status
  is_system_role       Boolean  @default(false)
  is_active            Boolean  @default(true)

  // Metadata
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  // Relations
  company QUAD_companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users   QUAD_users[]

  @@unique([company_id, role_code])
  @@index([company_id])
  @@index([role_code])
  @@index([is_active])
  @@index([hierarchy_level])
  @@map("QUAD_roles")
}

model QUAD_users {
  id             String   @id @default(uuid()) @db.Uuid
  company_id     String   @db.Uuid
  email          String   @unique @db.VarChar(255)
  password_hash  String   @db.VarChar(255)
  role_id        String?  @db.Uuid
  role           String   @default("DEVELOPER") @db.VarChar(50) // Legacy, will be deprecated
  full_name      String?  @db.VarChar(255)
  is_active      Boolean  @default(true)
  email_verified Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  company          QUAD_companies         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  user_role        QUAD_roles?            @relation(fields: [role_id], references: [id], onDelete: SetNull)
  sessions         QUAD_user_sessions[]
  domain_members   QUAD_domain_members[]
  adoption_matrix  QUAD_adoption_matrix?
  work_sessions    QUAD_work_sessions[]
  workload_metrics QUAD_workload_metrics[]
  flows_assigned   QUAD_flows[]           @relation("FlowAssignedTo")
  flows_created    QUAD_flows[]           @relation("FlowCreatedBy")
  circle_members   QUAD_circle_members[]
  circles_leading  QUAD_circles[]

  @@index([company_id])
  @@index([email])
  @@index([role_id])
  @@index([role])
  @@map("QUAD_users")
}

model QUAD_user_sessions {
  id            String    @id @default(uuid()) @db.Uuid
  user_id       String    @db.Uuid
  session_token String    @unique @db.VarChar(255)
  expires_at    DateTime
  ip_address    String?   @db.VarChar(50)
  user_agent    String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  user QUAD_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([session_token])
  @@index([expires_at])
  @@map("QUAD_user_sessions")
}

model QUAD_domains {
  id               String   @id @default(uuid()) @db.Uuid
  company_id       String   @db.Uuid
  name             String   @db.VarChar(255)
  parent_domain_id String?  @db.Uuid
  domain_type      String?  @db.VarChar(50)
  path             String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relations
  company          QUAD_companies        @relation(fields: [company_id], references: [id], onDelete: Cascade)
  parent_domain    QUAD_domains?         @relation("DomainHierarchy", fields: [parent_domain_id], references: [id], onDelete: Cascade)
  sub_domains      QUAD_domains[]        @relation("DomainHierarchy")
  members          QUAD_domain_members[]
  resources        QUAD_domain_resources[]
  flows            QUAD_flows[]
  circles          QUAD_circles[]
  workload_metrics QUAD_workload_metrics[]

  @@index([company_id])
  @@index([parent_domain_id])
  @@index([domain_type])
  @@index([path])
  @@map("QUAD_domains")
}

model QUAD_domain_members {
  id                    String   @id @default(uuid()) @db.Uuid
  user_id               String   @db.Uuid
  domain_id             String   @db.Uuid
  role                  String   @db.VarChar(50)
  allocation_percentage Int      @default(100)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relations
  user   QUAD_users   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  domain QUAD_domains @relation(fields: [domain_id], references: [id], onDelete: Cascade)

  @@unique([user_id, domain_id])
  @@index([user_id])
  @@index([domain_id])
  @@index([role])
  @@map("QUAD_domain_members")
}

// ============================================================================
// RESOURCE TABLES (EAV Pattern)
// ============================================================================

model QUAD_domain_resources {
  id              String   @id @default(uuid()) @db.Uuid
  domain_id       String   @db.Uuid
  resource_type   String   @db.VarChar(50)
  resource_name   String   @db.VarChar(255)
  resource_status String?  @default("pending_setup") @db.VarChar(50)
  created_by      String?  @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  domain     QUAD_domains               @relation(fields: [domain_id], references: [id], onDelete: Cascade)
  attributes QUAD_resource_attributes[]

  @@index([domain_id])
  @@index([resource_type])
  @@index([resource_status])
  @@map("QUAD_domain_resources")
}

model QUAD_resource_attributes {
  id              String   @id @default(uuid()) @db.Uuid
  resource_id     String   @db.Uuid
  attribute_name  String   @db.VarChar(50)
  attribute_value String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  resource QUAD_domain_resources @relation(fields: [resource_id], references: [id], onDelete: Cascade)

  @@unique([resource_id, attribute_name])
  @@index([resource_id])
  @@index([attribute_name])
  @@map("QUAD_resource_attributes")
}

// ============================================================================
// FEATURE TABLES
// ============================================================================

model QUAD_adoption_matrix {
  id                   String    @id @default(uuid()) @db.Uuid
  user_id              String    @unique @db.Uuid
  skill_level          Int       @default(1) // 1-3: Beginner, Intermediate, Expert
  trust_level          Int       @default(1) // 1-3: Low, Medium, High
  previous_skill_level Int?
  previous_trust_level Int?
  level_changed_at     DateTime?
  notes                String?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt

  // Relations
  user QUAD_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("QUAD_adoption_matrix")
}

model QUAD_workload_metrics {
  id               String   @id @default(uuid()) @db.Uuid
  user_id          String   @db.Uuid
  domain_id        String?  @db.Uuid
  period_start     DateTime @db.Date
  period_end       DateTime @db.Date
  period_type      String?  @default("week") @db.VarChar(20)
  assignments      Int      @default(0)
  completes        Int      @default(0)
  output_score     Decimal? @db.Decimal(5, 2)
  hours_worked     Decimal? @default(0) @db.Decimal(5, 2)
  target_hours     Decimal? @default(16) @db.Decimal(5, 2)
  days_worked      Int?     @default(0)
  target_days      Int?     @default(4)
  root_cause       String?  @db.VarChar(50)
  root_cause_notes String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relations
  user   QUAD_users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  domain QUAD_domains? @relation(fields: [domain_id], references: [id], onDelete: SetNull)

  @@unique([user_id, domain_id, period_start, period_end])
  @@index([user_id])
  @@index([domain_id])
  @@index([period_start, period_end])
  @@index([root_cause])
  @@map("QUAD_workload_metrics")
}

model QUAD_flows {
  id                      String    @id @default(uuid()) @db.Uuid
  domain_id               String    @db.Uuid
  title                   String    @db.VarChar(500)
  description             String?
  flow_type               String?   @default("feature") @db.VarChar(50)
  quad_stage              String    @default("Q") @db.VarChar(1) // Q, U, A, D
  stage_status            String?   @default("pending") @db.VarChar(20)
  question_started_at     DateTime?
  question_completed_at   DateTime?
  understand_started_at   DateTime?
  understand_completed_at DateTime?
  allocate_started_at     DateTime?
  allocate_completed_at   DateTime?
  deliver_started_at      DateTime?
  deliver_completed_at    DateTime?
  assigned_to             String?   @db.Uuid
  circle_number           Int?
  priority                String?   @default("medium") @db.VarChar(20)
  ai_estimate_hours       Decimal?  @db.Decimal(5, 2)
  buffer_pct              Int?
  actual_hours            Decimal?  @db.Decimal(5, 2)
  external_id             String?   @db.VarChar(100)
  external_url            String?
  created_by              String?   @db.Uuid
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  // Relations
  domain        QUAD_domains              @relation(fields: [domain_id], references: [id], onDelete: Cascade)
  assignee      QUAD_users?               @relation("FlowAssignedTo", fields: [assigned_to], references: [id])
  creator       QUAD_users?               @relation("FlowCreatedBy", fields: [created_by], references: [id])
  stage_history QUAD_flow_stage_history[]

  @@index([domain_id])
  @@index([quad_stage])
  @@index([stage_status])
  @@index([assigned_to])
  @@index([circle_number])
  @@index([priority])
  @@index([external_id])
  @@map("QUAD_flows")
}

model QUAD_flow_stage_history {
  id            String   @id @default(uuid()) @db.Uuid
  flow_id       String   @db.Uuid
  from_stage    String?  @db.VarChar(1)
  to_stage      String   @db.VarChar(1)
  from_status   String?  @db.VarChar(20)
  to_status     String   @db.VarChar(20)
  changed_by    String?  @db.Uuid
  change_reason String?
  created_at    DateTime @default(now())

  // Relations
  flow QUAD_flows @relation(fields: [flow_id], references: [id], onDelete: Cascade)

  @@index([flow_id])
  @@index([to_stage])
  @@map("QUAD_flow_stage_history")
}

model QUAD_work_sessions {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  session_date  DateTime @db.Date
  hours_worked  Decimal  @default(0) @db.Decimal(4, 2)
  is_workday    Boolean  @default(true)
  start_time    DateTime? @db.Time()
  end_time      DateTime? @db.Time()
  deep_work_pct Decimal? @db.Decimal(5, 2)
  meeting_hours Decimal? @db.Decimal(4, 2)
  notes         String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  user QUAD_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, session_date])
  @@index([user_id])
  @@index([session_date])
  @@index([is_workday])
  @@map("QUAD_work_sessions")
}

model QUAD_circles {
  id            String   @id @default(uuid()) @db.Uuid
  domain_id     String   @db.Uuid
  circle_number Int
  circle_name   String   @db.VarChar(100)
  description   String?
  lead_user_id  String?  @db.Uuid
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  domain  QUAD_domains          @relation(fields: [domain_id], references: [id], onDelete: Cascade)
  lead    QUAD_users?           @relation(fields: [lead_user_id], references: [id])
  members QUAD_circle_members[]

  @@unique([domain_id, circle_number])
  @@index([domain_id])
  @@index([lead_user_id])
  @@map("QUAD_circles")
}

model QUAD_circle_members {
  id             String   @id @default(uuid()) @db.Uuid
  circle_id      String   @db.Uuid
  user_id        String   @db.Uuid
  role           String?  @default("member") @db.VarChar(50)
  allocation_pct Int?     @default(100)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  circle QUAD_circles @relation(fields: [circle_id], references: [id], onDelete: Cascade)
  user   QUAD_users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([circle_id, user_id])
  @@index([circle_id])
  @@index([user_id])
  @@map("QUAD_circle_members")
}
